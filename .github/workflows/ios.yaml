name: iOS Build & TestFlight Deploy

on:
  push:
    branches:
      - ios

jobs:
  ios-release:
    runs-on: macos-latest
    strategy:
      matrix:
        node-version: [20.x]

    env:
      # Decide env/stage based on branch
      STAGE: ${{ github.ref == 'refs/heads/master' && 'prod' || 'dev' }}

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          ssh-key: ${{ secrets.GIT_SSH_KEY }}

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - run: npm install

      - name: Load Config JS
        env:
          FIREBASE_CONFIG_BASE64: ${{ secrets.TRENDLY_BRANDS_FIREBASE_CONFIG }}
          ENV_LOCAL_BASE64: ${{ secrets.ENV_LOCAL_FILE }}
        run: |
          echo $FIREBASE_CONFIG_BASE64 | base64 -d > firebase-config.js
          echo $ENV_LOCAL_BASE64 | base64 -d > .env.local

      - run: npx expo prebuild --platform ios --clean

      # 4️⃣ Install CocoaPods
      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      # 5️⃣ Setup Xcode
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      # 6️⃣ Create App Store Connect API Key
      - name: Create ASC API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${ASC_PRIVATE_KEY}" > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
        env:
          ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}

      # 7️⃣ Archive app
      - name: Archive iOS app
        run: |
          cd ios
          xcodebuild archive \
            -workspace TrendlyBrands.xcworkspace \
            -scheme TrendlyBrands \
            -configuration Release \
            -archivePath build/TrendlyBrands.xcarchive \
            -allowProvisioningUpdates

      # 8️⃣ Export IPA
      - name: Export IPA
        run: |
          cd ios
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/TrendlyBrands.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      # 9️⃣ Upload to TestFlight
      - name: Upload to TestFlight
        run: |
          xcrun iTMSTransporter \
            -m upload \
            -assetFile ios/build/ipa/TrendlyBrands.ipa \
            -apiKey ${{ secrets.ASC_KEY_ID }} \
            -apiIssuer ${{ secrets.ASC_ISSUER_ID }}